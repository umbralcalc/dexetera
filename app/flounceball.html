<!DOCTYPE html>
<html>
<head>
    <title>Flounceball Tactics</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="src/flounceball/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arsenal+SC:ital,wght@0,400;0,700;1,400;1,700&family=Oxygen:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>
<body>
    <div id="pitch" class="blurred">
        <img src="assets/flounceball-pitch.svg" alt="Pitch" id="pitchImage">
    </div>
    <div id="overlay">
        <div class="panels-container">
            <div class="panel">
                <h2>Rules of Flounceball:</h2>
                <p>1. The objective of the game is for each team to keep the ball in the air for as long as possible: this is called 'air time'.</p>
                <p>2. Possession alternates between each team, where the objective of the defensive side is to stop the ball from staying in the air by disrupting the attacking side.</p>
                <p>3. Defensive players are not allowed to touch the ball, but they may distrupt any of the attacking side players who are near the ball.</p>
                <p>4. Player substitutions may occur continuously throughout the match and there is no limit to them.</p>
                <p>5. The game takes place on a circular field and if the ball leaves this area at any time, then the attacking team possession is ended immediately.</p>
                <p>6. Possession also changes when the ball drops to the ground, at which point a restart occurs with the ball in the middle of the pitch.</p>
                <p>7. A match is 5 minutes of continuous play, without stoppages.</p>
            </div>
            <div class="panel">
                <h2>How to play:</h2>
                <p>You are the Flounceball team manager and tactician. You must guide your side to victory through player substitutions and continuously tweaking team tactics.</p> 
                <p>Edit/run this code below and then click the "Start Simulation" button to play:</p>
                <pre><code class="language-python">
from dexact.server import (
    ActionTaker, launch_websocket_server
)

class FlounceballActionTaker(ActionTaker):
    @property
    def state_map(self) -> dict[int, str]:
        """You can ignore this config property."""
        return {
            0: "latest_manager_actions",
            21: "latest_match_state",
        }

    def take_next_action(
        self, 
        time: float, 
        states: dict[str, list[float]]
    ) -> list[float]:
        """
        Modify this method to play!
        Also check out the manager cheatsheet if needed:
        umbralcalc.github.io/dexetera/cmd/flounceball/cheatsheet.md
        """
        return [s + 0.1 for s in states["latest_manager_actions"]]

if __name__ == "__main__":
    launch_websocket_server(FlounceballActionTaker())
                </code></pre>
                <button id="startButton">Start Simulation</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="src/google-protobuf.js"></script>
    <script src="src/partition_state_pb.js"></script>
    <script src="src/wasm_exec.js"></script>
    <script>
        document.getElementById('startButton').addEventListener('click', () => {
            const worker = new Worker('src/worker.js');
            worker.onmessage = function(event) {
                if (event.data.type === 'partitionState') {
                    const data = event.data.data;
                    updateViz(data);
                }
            };
            worker.postMessage({ 
                action: 'start', 
                wasmBinary: 'flounceball/main.wasm',
                serverPartitionIndices: [0, 21],
                stopAtSimTime: 300.0,
                debugMode: false
            });
            document.getElementById('pitch').classList.remove('blurred');
            document.getElementById('overlay').style.display = 'none';
        });
        function updateViz(data) {
            const timesteps = data.timesteps;
            const partitionIndex = data.partitionIndex;
            const state = data.state;

            // Time display in the top left corner
            if (partitionIndex === 21) {
                const timeDisplay = document.getElementById('timeDisplay');
                if (!timeDisplay) {
                    const newTimeDisplay = document.createElement('div');
                    newTimeDisplay.id = 'timeDisplay';
                    newTimeDisplay.style.position = 'absolute';
                    newTimeDisplay.style.top = '10px';
                    newTimeDisplay.style.left = '10px';
                    newTimeDisplay.style.color = '#FFF';
                    document.getElementById('pitch').appendChild(newTimeDisplay);
                }
                let minutes = Math.floor(timesteps / 60);
                let seconds = Math.floor(timesteps % 60);
                seconds = seconds.toString().padStart(2, '0');
                document.getElementById('timeDisplay').textContent = `Time: ${minutes}:${seconds}`;
                
                // Scores update
                const scoreDisplay = document.getElementById('scoreDisplay');
                if (!scoreDisplay) {
                    const newScoreDisplay = document.createElement('div');
                    newScoreDisplay.id = 'scoreDisplay';
                    newScoreDisplay.style.position = 'absolute';
                    newScoreDisplay.style.top = '30px';
                    newScoreDisplay.style.left = '10px';
                    newScoreDisplay.style.color = '#FFF';
                    document.getElementById('pitch').appendChild(newScoreDisplay);
                }
                document.getElementById('scoreDisplay').textContent = 
                    `Your Team: ${state[2].toFixed(2)} | Other Team: ${state[3].toFixed(2)}`;
            }

            // Player positions update
            if (partitionIndex >= 1 && partitionIndex <= 20) {
                const playerDotId = `playerDot${partitionIndex}`;
                let playerDot = document.getElementById(playerDotId);
                if (!playerDot) {
                    playerDot = document.createElement('div');
                    playerDot.id = playerDotId;
                    playerDot.style.position = 'absolute';
                    playerDot.style.width = '10px';
                    playerDot.style.height = '10px';
                    if (partitionIndex <= 10) {
                        playerDot.style.backgroundColor = 'red';
                    } else {
                        playerDot.style.backgroundColor = 'blue';
                    }
                    playerDot.style.borderRadius = '50%';
                    document.getElementById('pitch').appendChild(playerDot);
                }
                // TODO: Transform from radial and angular here with origin at image centre...
                playerDot.style.left = `${state[0]}px`;
                playerDot.style.top = `${state[1]}px`;
            }
        }
    </script>
</body>
</html>
