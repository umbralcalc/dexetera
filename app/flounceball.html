<!DOCTYPE html>
<html>
<head>
    <title>Flounceball Tactics</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="src/flounceball/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arsenal+SC:ital,wght@0,400;0,700;1,400;1,700&family=Oxygen:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
</head>
<body>
    <div id="pitch">
        <svg version="1.1" viewBox="0.0 0.0 1010.8293963254594 625.7034120734908" fill="none" stroke="none" stroke-linecap="square" stroke-miterlimit="10" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">
            <clipPath id="p.0">
                <path d="m0 0l1010.8294 0l0 625.7034l-1010.8294 0l0 -625.7034z" clip-rule="nonzero"/>
            </clipPath>
            <g clip-path="url(#p.0)">
                <path fill="#6aa84f" d="m0 0l1010.8294 0l0 625.7034l-1010.8294 0z" fill-rule="evenodd"/>
                <path fill="#000000" fill-opacity="0.0" d="m234.79265 312.8517l0 0c0 -148.96904 121.63048 -269.7323 271.6693 -269.7323l0 0c72.05118 0 141.15134 28.418144 192.09921 79.002754c50.947876 50.584625 79.57007 119.19208 79.57007 190.72954l0 0c0 148.96902 -121.63049 269.73227 -271.66928 269.73227l0 0c-150.03882 0 -271.6693 -120.763245 -271.6693 -269.73227z" fill-rule="evenodd"/>
                <path stroke="#ffffff" stroke-width="4.0" stroke-linejoin="round" stroke-linecap="butt" d="m234.79265 312.8517l0 0c0 -148.96904 121.63048 -269.7323 271.6693 -269.7323l0 0c72.05118 0 141.15134 28.418144 192.09921 79.002754c50.947876 50.584625 79.57007 119.19208 79.57007 190.72954l0 0c0 148.96902 -121.63049 269.73227 -271.66928 269.73227l0 0c-150.03882 0 -271.6693 -120.763245 -271.6693 -269.73227z" fill-rule="evenodd"/>
                <path fill="#000000" fill-opacity="0.0" d="m278.1286 310.67978l0 0c0 -128.36488 102.22714 -232.42519 228.33072 -232.42519l0 0c60.557037 0 118.63388 24.487587 161.4542 68.07576c42.820312 43.58818 66.876526 102.706436 66.876526 164.34943l0 0c0 128.3649 -102.22717 232.4252 -228.33072 232.4252l0 0c-126.10358 0 -228.33072 -104.0603 -228.33072 -232.4252z" fill-rule="evenodd"/>
                <path stroke="#ffffff" stroke-width="2.0" stroke-linejoin="round" stroke-linecap="butt" stroke-dasharray="8.0,6.0" d="m278.1286 310.67978l0 0c0 -128.36488 102.22714 -232.42519 228.33072 -232.42519l0 0c60.557037 0 118.63388 24.487587 161.4542 68.07576c42.820312 43.58818 66.876526 102.706436 66.876526 164.34943l0 0c0 128.3649 -102.22717 232.4252 -228.33072 232.4252l0 0c-126.10358 0 -228.33072 -104.0603 -228.33072 -232.4252z" fill-rule="evenodd"/>
                <path fill="#000000" fill-opacity="0.0" d="m450.91077 312.85303l0 0c0 -30.64093 24.402252 -55.480316 54.503937 -55.480316l0 0c14.455353 0 28.318634 5.845215 38.54007 16.249786c10.221497 10.404602 15.963867 24.516235 15.963867 39.23053l0 0c0 30.64093 -24.402222 55.480316 -54.503937 55.480316l0 0c-30.101685 0 -54.503937 -24.839386 -54.503937 -55.480316z" fill-rule="evenodd"/>
                <path stroke="#ffffff" stroke-width="2.0" stroke-linejoin="round" stroke-linecap="butt" stroke-dasharray="8.0,6.0" d="m450.91077 312.85303l0 0c0 -30.64093 24.402252 -55.480316 54.503937 -55.480316l0 0c14.455353 0 28.318634 5.845215 38.54007 16.249786c10.221497 10.404602 15.963867 24.516235 15.963867 39.23053l0 0c0 30.64093 -24.402222 55.480316 -54.503937 55.480316l0 0c-30.101685 0 -54.503937 -24.839386 -54.503937 -55.480316z" fill-rule="evenodd"/>
                <path fill="#ffffff" d="m499.91077 312.85303l0 0c0 -3.679016 2.9330444 -6.661438 6.551178 -6.661438l0 0c1.7374878 0 3.4038086 0.70184326 4.6323853 1.9511108c1.2286072 1.2492371 1.9187927 2.9436035 1.9187927 4.710327l0 0c0 3.6789856 -2.933075 6.6614075 -6.551178 6.6614075l0 0c-3.6181335 0 -6.551178 -2.9824219 -6.551178 -6.6614075z" fill-rule="evenodd"/>
                <path stroke="#ffffff" stroke-width="2.0" stroke-linejoin="round" stroke-linecap="butt" d="m499.91077 312.85303l0 0c0 -3.679016 2.9330444 -6.661438 6.551178 -6.661438l0 0c1.7374878 0 3.4038086 0.70184326 4.6323853 1.9511108c1.2286072 1.2492371 1.9187927 2.9436035 1.9187927 4.710327l0 0c0 3.6789856 -2.933075 6.6614075 -6.551178 6.6614075l0 0c-3.6181335 0 -6.551178 -2.9824219 -6.551178 -6.6614075z" fill-rule="evenodd"/>
            </g>
            </svg>
    </div>
    <div id="overlay">
        <div class="panels-container">
            <div class="panel">
                <h2>The role of Flounceball Team Manager:</h2>
                <p>1. You've been made the manager of a mysterious sport named 'flounceball', with unknown and seemingly random rules.</p>
                <p>2. The objective of the game is for your team to score more points than the opposition team, but how they are directly scored is hidden from you.</p>
                <p>3. All you know is, at different times, players will perform poorly and others will perform really well, depending entirely on their pitch location.</p>
                <p>4. To influence the game as a manager, you can continuously teleport your players to different positions on the circular field.</p>
                <p>5. You have 5 minutes. Good luck.</p>
            </div>
            <div class="panel">
                <h2>How to play:</h2>
                <p>Edit/run this code below and then click the "Start Simulation" button to play:</p>
                <pre><code class="language-python">
import math, random, itertools # libs only needed for example
from dexact.server import ActionTaker, launch_websocket_server


class FlounceballActionTaker(ActionTaker):
    @property
    def state_map(self) -> dict[int, str]:
        """You can ignore this config property."""
        return {
            0: "latest_manager_actions",
            22: "latest_match_state",
        }

    def take_next_action(
        self, 
        time: float,
        states: dict[str, list[float]]
    ) -> list[float]:
        """
        Modify this method to play!
        Also check out the manager cheatsheet if needed:
        umbralcalc.github.io/dexetera/cmd/flounceball/cheatsheet.md
        """
        return list(itertools.chain(*[
            (random.uniform(0, 100), random.uniform(0, 2*math.pi)) 
            for _ in range(0, 10)
        ]))


if __name__ == "__main__":
    launch_websocket_server(FlounceballActionTaker())
                </code></pre>
                <button id="startButton">Start Simulation</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="src/google-protobuf.js"></script>
    <script src="src/partition_state_pb.js"></script>
    <script src="src/wasm_exec.js"></script>
    <script>
        document.getElementById('startButton').addEventListener('click', () => {
            const worker = new Worker('src/worker.js');
            worker.onmessage = function(event) {
                if (event.data.type === 'partitionState') {
                    const data = event.data.data;
                    updateViz(data);
                }
            };
            worker.postMessage({ 
                action: 'start', 
                wasmBinary: 'flounceball/main.wasm',
                serverPartitionIndices: [0, 22],
                stopAtSimTime: 300.05,
                debugMode: false
            });
            document.getElementById('pitch').classList.remove('blurred');
            document.getElementById('overlay').style.display = 'none';
        });
        function updateViz(data) {
            const timesteps = data.timesteps;
            const partitionIndex = data.partitionIndex;
            const state = data.state;
            const pitch = document.getElementById('pitch');

            // Time and score display in the top left corner
            if (partitionIndex === 22) {
                // Time display setup
                let timeDisplay = document.getElementById('timeDisplay');
                if (!timeDisplay) {
                    timeDisplay = document.createElement('div');
                    timeDisplay.id = 'timeDisplay';
                    timeDisplay.style.position = 'absolute';
                    timeDisplay.style.top = '10px';
                    timeDisplay.style.left = '10px';
                    timeDisplay.style.color = '#FFF';
                    timeDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                    timeDisplay.style.padding = '10px';
                    timeDisplay.style.borderRadius = '8px';
                    timeDisplay.style.fontSize = '18px';
                    timeDisplay.style.fontFamily = 'Arial, sans-serif';
                    timeDisplay.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.3)';
                    timeDisplay.style.transition = 'all 0.3s ease';
                    pitch.appendChild(timeDisplay);
                }

                let minutes = Math.floor(timesteps / 60);
                let seconds = Math.floor(timesteps % 60);
                seconds = seconds.toString().padStart(2, '0');
                timeDisplay.textContent = `Time: ${minutes}:${seconds}`;

                // Score display setup
                let scoreDisplay = document.getElementById('scoreDisplay');
                if (!scoreDisplay) {
                    scoreDisplay = document.createElement('div');
                    scoreDisplay.id = 'scoreDisplay';
                    scoreDisplay.style.position = 'absolute';
                    scoreDisplay.style.top = '60px';
                    scoreDisplay.style.left = '10px';
                    scoreDisplay.style.color = '#FFF';
                    scoreDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                    scoreDisplay.style.padding = '10px';
                    scoreDisplay.style.borderRadius = '8px';
                    scoreDisplay.style.fontSize = '18px';
                    scoreDisplay.style.fontFamily = 'Arial, sans-serif';
                    scoreDisplay.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.3)';
                    scoreDisplay.style.transition = 'all 0.3s ease';
                    pitch.appendChild(scoreDisplay);
                }

                scoreDisplay.innerHTML = `
                    <span style="color: red;">Your Team: ${state[0].toFixed(2)}</span> | 
                    <span style="color: blue;">Other Team: ${state[1].toFixed(2)}</span>
                `;
            }

            // Player positions update
            if (partitionIndex >= 1 && partitionIndex <= 20) {
                const playerDotId = `playerDot${partitionIndex}`;
                let playerDot = document.getElementById(playerDotId);
                if (!playerDot) {
                    playerDot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    playerDot.setAttribute("id", playerDotId);
                    playerDot.setAttribute("r", "5");
                    if (partitionIndex <= 10) {
                        playerDot.setAttribute("fill", "red");
                    } else {
                        playerDot.setAttribute("fill", "blue");
                    }
                    pitch.querySelector("svg").appendChild(playerDot);
                }
                // Transform from radial and angular here with origin at image centre
                const simPitchRadius = 100.0;
                const r = state[0] * (271.6693 / simPitchRadius);
                const theta = state[1];
                const centreX = 506.46195;
                const centreY = 312.8517;
                const x = centreX + r * Math.cos(theta);
                const y = centreY + r * Math.sin(theta);
                playerDot.setAttribute("cx", x);
                playerDot.setAttribute("cy", y);
            }
        }
    </script>
</body>
</html>
